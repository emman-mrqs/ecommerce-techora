<!-- /views/user/products.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TECHORA Products | Shop Now</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/products.css">
</head>

<body>
  <nav><%- include("../partials/header.ejs") %></nav>

  <%
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Server-side URL helper so pagination/sorting links are rendered by EJS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildUrl(next){
      const qs = [];
      if (typeof search !== 'undefined' && search) qs.push('search=' + encodeURIComponent(search));
      if (typeof sort   !== 'undefined' && sort)   qs.push('sort='   + encodeURIComponent(sort));
      if (next && next.page)                       qs.push('page='   + encodeURIComponent(next.page));
      return '/products' + (qs.length ? ('?' + qs.join('&')) : '');
    }
  %>

  <div class="container1">
    <!-- Header / Seller -->
    <section class="shop-related-seller-box" data-animate>
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="shop-related-title">
          <% if (search) { %>
            Shop related to: <strong>"<%= search %>"</strong>
          <% } else { %>
            All Products
          <% } %>
        </div>
        <% if (search) { %>
          <span class="chip"><i class="fa-solid fa-magnifying-glass"></i><span> Filtered results</span></span>
        <% } %>
      </div>

      <div class="shop-seller-card">
        <% if (sellerCard) { %>
          <!-- Seller Avatar -->
          <div class="seller-logo">
            <% if (sellerCard && sellerCard.store_icon) { %>
              <img src="<%= sellerCard.store_icon %>" alt="Seller logo"
                  onerror="this.replaceWith(makeInitials('<%= (sellerCard.store_name||'S') %>'))">
            <% } else { %>
              <div class="avatar-initials"><%= (sellerCard.store_name||'S').slice(0,2).toUpperCase() %></div>
            <% } %>
          </div>


          <!-- Seller Info -->
          <div class="seller-details">
            <div class="seller-name"><%= sellerCard.store_name || 'Seller' %></div>
            <div class="seller-followers">0 Followers</div> <!-- static as requested -->
          </div>

          <!-- Seller Stats -->
          <div class="seller-stats">
            <div class="stat-box">
              <div class="stat-label">Products</div>
              <div class="stat-value"><%= sellerCard.product_count ?? 0 %></div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Rating</div>
              <div class="stat-value"><%= (Number(sellerCard.avg_rating||0)).toFixed(1) %></div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Response</div>
              <div class="stat-value">Within minutes</div> <!-- static as requested -->
            </div>

            <div class="d-flex align-items-center">
              <a class="btn btn-outline-dark btn-sm ms-2"
                 href="/sellers?show=all<%= search?('&search='+encodeURIComponent(search)) : '' %>">
                Show all sellers
              </a>
            </div>
          </div>
        <% } else { %>
          <div class="text-muted">No seller info available.</div>
        <% } %>
      </div>
    </section>

    <!-- Sort + Pagination bar -->
    <section class="sort-pagination-bar" data-animate>
      <div class="sort-by-group">
        <span class="sort-label">Sort by:</span>

        <!-- Use anchors so no JS required to navigate -->
        <a class="sort-btn <%= sort==='relevance'?'active':'' %>" href="<%= buildUrl({page:1}) %>">Relevance</a>
        <a class="sort-btn <%= sort==='latest'?'active':'' %>"    href="/products?<%= [
              search?('search='+encodeURIComponent(search)):'',
              'sort=latest','page=1'
            ].filter(Boolean).join('&') %>">Latest</a>
        <a class="sort-btn <%= sort==='top-sales'?'active':'' %>" href="/products?<%= [
              search?('search='+encodeURIComponent(search)):'',
              'sort=top-sales','page=1'
            ].filter(Boolean).join('&') %>">Top Sales</a>

        <div class="sort-dropdown">
          <button class="sort-btn dropdown-toggle <%= (sort==='price-low'||sort==='price-high')?'active':'' %>">Price ‚ñæ</button>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/products?<%= [
                  search?('search='+encodeURIComponent(search)):'',
                  'sort=price-low','page=1'
                ].filter(Boolean).join('&') %>">Low to High</a>
            <a class="dropdown-item" href="/products?<%= [
                  search?('search='+encodeURIComponent(search)):'',
                  'sort=price-high','page=1'
                ].filter(Boolean).join('&') %>">High to Low</a>
          </div>
        </div>
      </div>

      <!-- Pagination (windowed to 10 pages) -->
      <div class="pagination-group">
        <span class="page-count">
          <span class="current-page"><%= page %></span>/<span class="total-pages"><%= totalPages %></span>
        </span>

        <a class="page-btn <%= page<=1?'disabled':'' %>"
           href="<%= page<=1 ? '#' : buildUrl({page: page-1}) %>">&lt;</a>

        <%
          const windowSize = 10;
          const currentWindow = Math.floor((page-1)/windowSize);
          const start = currentWindow*windowSize + 1;
          const end = Math.min(start + windowSize - 1, totalPages);
          for(let p=start; p<=end; p++){
        %>
          <a class="page-btn <%= p===page?'active':'' %>" href="<%= buildUrl({page:p}) %>"><%= p %></a>
        <% } %>

        <a class="page-btn <%= page>=totalPages?'disabled':'' %>"
           href="<%= page>=totalPages ? '#' : buildUrl({page: page+1}) %>">&gt;</a>
      </div>
    </section>

    <!-- Products Grid -->
    <section class="products-grid" data-animate>
      <% if (products && products.length) { %>
        <% products.forEach(p => { %>
          <a href="/buy/<%= p.id %>" class="clean-product-card">
            <div class="product-img">
              <% if (p.img_url) { %>
                <img src="<%= p.img_url %>"
                     alt="<%= p.name %>"
                     style="width:100%;height:100%;object-fit:contain"
                     onerror="this.onerror=null;this.src='/images/default.png'">
              <% } else { %>
                üõçÔ∏è
              <% } %>
            </div>
            <div class="product-info">
              <div class="product-name"><%= p.name %></div>
              <% if (p.price != null) { %>
                <div class="product-price">‚Ç±<%= Number(p.price).toLocaleString() %></div>
              <% } %>
            </div>
          </a>
        <% }) %>
      <% } else { %>
        <div class="text-muted">No products found<%= search?(' for "'+search+'"') : '' %>.</div>
      <% } %>
    </section>
  </div>

  <footer><%- include("../partials/footer.ejs") %></footer>
  <script src="/js/products.js"></script>

</body>
</html>
