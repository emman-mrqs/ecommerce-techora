<!-- /views/user/buy.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= product.name %> — Buy | Techora</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/buy.css"/>

  <style>
    :root{
      --bg:#FFFFFF; --ink:#0A0A0A; --muted:#4D4D4D; --line:#E0E0E0; --card:#FAFAFA;
      --btn:#000; --btnText:#fff; --hover:#333;
      --radius:16px; --shadow:0 12px 32px rgba(0,0,0,.08);
    }
    /* subtle reveal */
    [data-animate]{opacity:0; transform:translateY(14px); transition:all .5s cubic-bezier(.2,.8,.2,1)}
    [data-animate].in{opacity:1; transform:none}
    .accordion-button:focus{box-shadow:none}
    .reviews .star{font-size:18px; color:#CFCFCF}
    .reviews .star.on{color:#000}
    .review-card{border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff}
    .related .product-card{transition:transform .25s ease, box-shadow .25s}
    .related .product-card:hover{transform:translateY(-4px); box-shadow:0 14px 30px rgba(0,0,0,.12)}
    .seller-reply{background:#FAFAFA;border:1px solid var(--line);border-radius:10px;padding:10px}
    .dropdown-table { border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    .dropdown-table .table{ margin:0; }
    /* Buy page – wishlist button micro states */
#btn-wishlist.saved { background:#000; color:#fff; border-color:#000; }
#btn-wishlist .fa-heart { transition: transform .15s ease; }
#btn-wishlist.pressed .fa-heart { transform: scale(1.2); }

  </style>
</head>
<body>
<header><%- include("../partials/header.ejs") %></header>

<main class="page">
  <!-- ========== PRODUCT TOP ========== -->
  <section class="product-detail" role="region" aria-label="Product details" data-animate>
    <!-- Gallery -->
    <%
    const RAW_IMGS = images || [];
    const seen = new Set();
    const DEDUP = [];
    for (const im of RAW_IMGS) {
      const url = im?.img_url;
      if (url && !seen.has(url)) { seen.add(url); DEDUP.push(im); }
    }
    const GENERAL_IMGS = DEDUP.filter(i => !i.product_variant_id);
    const VARIANT_IMGS = DEDUP.filter(i => i.product_variant_id);
    const MAIN_IMG = (GENERAL_IMGS.find(i => i.is_primary) || GENERAL_IMGS[0] || DEDUP[0] || { img_url: '/images/default.png' });
    %>

    <aside class="product-gallery" aria-label="Product images">
      <figure class="main-image">
        <img src="<%= MAIN_IMG.img_url %>"
            alt="<%= product.name %> main image"
            id="mainProductImage"/>
      </figure>

      <div class="image-thumbnails" role="list">
        <% GENERAL_IMGS.forEach((img, index) => { %>
          <img role="listitem"
              src="<%= img.img_url %>"
              data-variant-id=""
              alt="Image <%= index + 1 %>"
              class="<%= index === 0 ? 'active' : '' %>" />
        <% }) %>

        <% VARIANT_IMGS.forEach((img) => { %>
          <img role="listitem"
              src="<%= img.img_url %>"
              data-variant-id="<%= img.product_variant_id %>"
              alt="Variant image"
              style="display:none" />
        <% }) %>
      </div>
    </aside>

    <!-- Info (we removed the long description from here and will show it below in the dropdown) -->
    <section class="product-info">
      <h1 class="product-title"><%= product.name %></h1>

      <div class="price-range" aria-live="polite">
        <%
          const prices = variants.map(v => parseFloat(v.price));
          const minPrice = Math.min(...prices).toFixed(2);
          const maxPrice = Math.max(...prices).toFixed(2);
        %>
        <div class="price" id="price-display">₱<%= minPrice %> – ₱<%= maxPrice %></div>
      </div>

      <!-- Variants -->
      <div class="variant-section">
        <label class="variant-label" for="color-options">Color:</label>
        <div id="color-options" class="variant-options" role="group" aria-label="Color options">
          <%
            const colors = [...new Set(variants.map(v => v.color))];
            colors.forEach(color => {
          %>
            <button type="button" class="variant-btn" aria-pressed="false" data-color="<%= color %>"><%= color %></button>
          <% }); %>
        </div>

        <label class="variant-label" for="ram-storage-options">RAM + Storage:</label>
        <div id="ram-storage-options" class="variant-options" role="group" aria-label="RAM + Storage options">
          <%
            const ramStorages = [...new Set(variants.map(v => `${v.ram}GB + ${v.storage}GB`))];
            ramStorages.forEach(rs => {
              const [ram, storage] = rs.split(" + ");
          %>
            <button type="button"
                    class="variant-btn"
                    aria-pressed="false"
                    data-ram="<%= ram.replace('GB','') %>"
                    data-storage="<%= storage.replace('GB','') %>">
              <%= rs %>
            </button>
          <% }); %>
        </div>
      </div>

      <!-- Quantity + total -->
      <div class="quantity-section mt-3">
        <label class="variant-label" for="qty-input">Quantity:</label>
        <div class="quantity-control">
          <button type="button" class="qty-btn" aria-label="Decrease quantity">−</button>
          <input id="qty-input" type="number" min="1" value="1" inputmode="numeric" />
          <button type="button" class="qty-btn" aria-label="Increase quantity">+</button>
        </div>
        <span class="stock-info">In Stock: 0</span>
      </div>

      <div class="total-section mt-2">
        <strong id="total-amount">Total: ₱0.00</strong>
      </div>

<div class="action-buttons mt-3 d-flex flex-wrap gap-2">
  <button id="btn-add" class="btn btn-outline-dark" type="button">Add to Cart</button>
  <button id="btn-buy" class="btn btn-dark" type="button">Buy Now</button>

  <!-- NEW: Add to Wishlist (variant-level) -->
  <button id="btn-wishlist" class="btn btn-outline-dark d-inline-flex align-items-center gap-2" type="button" aria-pressed="false">
    <i class="fa-regular fa-heart" aria-hidden="true"></i>
    <span>Add to Wishlist</span>
  </button>
</div>

    </section>
  </section>

  <!-- ========== DETAILS DROPDOWN (description + specs) ========== -->
  <section class="mt-4" data-animate>
    <div class="accordion dropdown-table" id="detailsAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pdetails">
            <strong>Product Details & Specifications</strong>
          </button>
        </h2>
        <div id="pdetails" class="accordion-collapse collapse" data-bs-parent="#detailsAccordion">
          <div class="accordion-body p-0">
            <table class="table table-striped mb-0">
              <tbody>
                <tr>
                  <th style="width:220px">Description</th>
                  <td class="text-muted"><%= product.description || '—' %></td>
                </tr>
                <tr>
                  <th>Available Colors</th>
                  <td class="text-muted"><%= colors.join(', ') %></td>
                </tr>
                <tr>
                  <th>RAM / Storage Options</th>
                  <td class="text-muted"><%= ramStorages.join(', ') %></td>
                </tr>
                <tr>
                  <th>Price Range</th>
                  <td class="text-muted">₱<%= minPrice %> – ₱<%= maxPrice %></td>
                </tr>
                <tr>
                <th>Seller</th>
                <td class="text-muted">
                  <a href="/store/<%= product.seller_id %>" class="text-decoration-none text-dark">
                    <%= product.store_name ? product.store_name : `Seller #${product.seller_id}` %>
                  </a>
                </td>
              </tr>
                <tr>
                  <th>SKU Variants</th>
                  <td class="text-muted"><%= variants.length %> variants</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

<!-- ========== RATINGS ========== -->
<section class="reviews mt-5" data-animate>
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="m-0 fw-bold">Ratings & Reviews</h4>
    <small class="text-muted" id="reviews-count">—</small>
  </div>

  <ul class="nav nav-tabs" id="reviewTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="tab-all" data-bs-toggle="tab" data-bs-target="#pane-all" type="button">
        All Reviews <span class="badge bg-dark ms-1" id="badge-count">0</span>
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-verified" data-bs-toggle="tab" data-bs-target="#pane-verified" type="button">
        Verified Buyers
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-write" data-bs-toggle="tab" data-bs-target="#pane-write" type="button">
        Write a Review
      </button>
    </li>
  </ul>

  <div class="tab-content border-start border-end border-bottom p-3 rounded-bottom">
    <div class="tab-pane fade show active" id="pane-all" role="tabpanel">
      <div id="reviewsList" class="vstack gap-3"></div>
    </div>

    <div class="tab-pane fade" id="pane-verified" role="tabpanel">
      <div id="reviewsListVerified" class="vstack gap-3"></div>
    </div>

    <div class="tab-pane fade" id="pane-write" role="tabpanel">
      <% if (canReview) { %>
        <form id="reviewForm" class="border rounded-3 p-3">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Your Rating</label>
              <select class="form-select" name="rating" required>
                <option value="">Select…</option>
                <option value="5">★★★★★ — Excellent</option>
                <option value="4">★★★★☆ — Good</option>
                <option value="3">★★★☆☆ — Average</option>
                <option value="2">★★☆☆☆ — Poor</option>
                <option value="1">★☆☆☆☆ — Terrible</option>
              </select>
            </div>
            <div class="col-md-9">
              <label class="form-label">Your Review</label>
              <textarea class="form-control" name="body" rows="3"
                        placeholder="Share details about build quality, battery, sound, etc."
                        required></textarea>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-dark" type="submit">Submit Review</button>
            <small class="text-muted">Only buyers who completed an order can post.</small>
          </div>
        </form>
      <% } else { %>
        <div class="alert alert-light border d-flex align-items-center gap-2 m-0">
          <i class="fa-regular fa-circle-check"></i>
          <div>Only customers with a completed order for this product can leave a rating.</div>
        </div>
      <% } %>
    </div>
  </div>
</section>



  <!-- ========== RELATED PRODUCTS ========== -->
  <section class="related mt-5" data-animate>
    <h4 class="fw-bold mb-3">Related Products</h4>
    <div class="row g-4">
      <% (relatedProducts || []).forEach(r => { %>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="product-card p-2 border rounded-3">
            <img src="<%= r.img_url || '/images/no-image.png' %>" alt="<%= r.name %>" class="w-100" style="aspect-ratio:4/3;object-fit:cover;border-radius:10px;">
            <div class="pt-2">
              <div class="fw-semibold"><%= r.name %></div>
              <div class="small text-muted">₱<%= Number(r.price).toLocaleString() %></div>
              <a href="/buy/<%= r.id %>" class="btn btn-outline-dark btn-sm mt-2 w-100">View</a>
            </div>
          </div>
        </div>
      <% }) %>
      <% if(!(relatedProducts||[]).length){ %>
        <div class="text-muted">No related products yet.</div>
      <% } %>
    </div>
  </section>
</main>

<footer><%-/* include("../partials/footer.ejs") */%></footer>

<!-- Data blobs -->
<script type="application/json" id="product-data"><%- JSON.stringify(product) %></script>
<script type="application/json" id="variants-data"><%- JSON.stringify(variants) %></script>
<script>
  // reveal on scroll
  const io=new IntersectionObserver(es=>es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in');io.unobserve(e.target)}}),{threshold:.1});
  document.querySelectorAll('[data-animate]').forEach(el=>io.observe(el));
</script>

<script type="module" src="/js/buy.js"></script>
<script type="module" src="/js/review.js"></script>
</body>
</html>
