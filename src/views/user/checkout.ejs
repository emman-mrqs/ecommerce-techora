<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECHORA - Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/checkout.css">
</head>
<body>
    <nav>
        <%- include("../partials/header.ejs") %>
    </nav>

    <div class="checkout-container">
        <div class="container">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="steps-container">
                    <div class="progress-line">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    
                    <div class="step">
                        <div class="step-circle active" id="step-1-circle">1</div>
                        <div class="step-title active" id="step-1-title">Shipping Information</div>
                    </div>
                    
                    <div class="step">
                        <div class="step-circle" id="step-2-circle">2</div>
                        <div class="step-title" id="step-2-title">Payment Information</div>
                    </div>
                    
                    <div class="step">
                        <div class="step-circle" id="step-3-circle">3</div>
                        <div class="step-title" id="step-3-title">Order Review</div>
                    </div>
                    
                    <div class="step">
                        <div class="step-circle" id="step-4-circle">4</div>
                        <div class="step-title" id="step-4-title">Confirmation</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8 col-md-7">
                    <!-- Step 1: Shipping Information -->
                    <div class="step-content active" id="step-1">
                        <div class="checkout-card">
                           <h3 class="card-title">SHIPPING INFORMATION</h3>

                            <!-- Saved Address Section -->
                            <% if (addresses && addresses.length > 0) { %>
                            <div class="form-group mb-3">
                                <label class="form-label">Choose Saved Address</label>
                                <select class="form-select" id="savedAddressSelect" required>
                                <option value="">-- Select an address --</option>
                                <% addresses.forEach(addr => { %>
                                    <option value="<%= addr.id %>"
                                    data-firstname="<%= addr.first_name %>"
                                    data-lastname="<%= addr.last_name %>"
                                    data-street="<%= addr.street %>"
                                    data-city="<%= addr.city %>"
                                    data-province="<%= addr.province %>"
                                    data-zip="<%= addr.zip %>"
                                    data-phone="<%= addr.phone %>"
                                    data-email="<%= addr.email %>"
                                    <%= addr.is_default ? "selected" : "" %>>
                                    <%= addr.first_name %> <%= addr.last_name %>, <%= addr.street %>, <%= addr.city %>
                                    </option>
                                <% }) %>
                                </select>
                            </div>
                            <% } else { %>
                            <div class="alert alert-warning d-flex justify-content-between align-items-center">
                                <span>No saved shipping address found.</span>
                                <a href="/profile#settings" class="btn btn-sm btn-primary">Setup Address</a>
                            </div>
                            <% } %>

                            <!-- First + Last Name -->
                            <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName"
                                        value="<%= defaultAddress ? defaultAddress.first_name : '' %>"
                                        placeholder="Enter first name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName"
                                        value="<%= defaultAddress ? defaultAddress.last_name : '' %>"
                                        placeholder="Enter last name" required>
                                </div>
                            </div>
                            </div>

                                <!-- Street Address -->
                                <div class="form-group">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="address"
                                        value="<%= defaultAddress ? defaultAddress.street : '' %>"
                                        placeholder="Enter street address" required>
                                </div>

                                <!-- City / Province / ZIP -->
                                <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" id="city"
                                            value="<%= defaultAddress ? defaultAddress.city : '' %>"
                                            placeholder="Enter city" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                    <label class="form-label">Province</label>
                                    <!-- using text input so any province value from DB is valid -->
                                    <input type="text" class="form-control" id="province"
                                            value="<%= defaultAddress ? defaultAddress.province : '' %>"
                                            placeholder="Enter province" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                    <label class="form-label">ZIP Code</label>
                                    <input type="text" class="form-control" id="zipCode"
                                            value="<%= defaultAddress ? defaultAddress.zip : '' %>"
                                            placeholder="Enter ZIP" required>
                                    </div>
                                </div>
                                </div>

                                <!-- Phone / Email -->
                                <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone"
                                            value="<%= defaultAddress ? defaultAddress.phone : '' %>"
                                            placeholder="Enter phone number" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email"
                                            value="<%= defaultAddress ? defaultAddress.email : '' %>"
                                            placeholder="Enter email address" required>
                                    </div>
                                </div>
                            </div>

                            <div class="step-buttons">
                                <button class="btn btn-primary" onclick="nextStep()">Continue to Payment</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Payment Information -->
                    <!-- Step 2: Payment Information -->
                    <div class="step-content" id="step-2">
                    <div class="checkout-card">
                        <h3 class="card-title">PAYMENT INFORMATION</h3>

                        <% const allowCOD = settings?.pay_cod !== false; %>
                        <% const allowPayPal = settings?.pay_paypal !== false; %>

                        <% if (allowPayPal) { %>
                        <div class="payment-option <%= allowPayPal ? 'selected' : '' %>" onclick="selectPayment(event, 'paypal')">
                        <input type="radio" name="payment" value="paypal" class="payment-radio" <%= allowPayPal ? 'checked' : '' %> >
                        <div class="payment-details">
                            <div class="payment-title">PayPal</div>
                            <div class="payment-desc">Pay securely with your PayPal account</div>
                        </div>
                        <i class="fab fa-paypal" style="font-size: 1.5rem; color: #0070ba;"></i>
                        </div>
                        <% } %>

                        <% if (allowCOD) { %>
                        <div class="payment-option <%= !allowPayPal ? 'selected' : '' %>" onclick="selectPayment(event, 'cod')">
                        <input type="radio" name="payment" value="cod" class="payment-radio" <%= !allowPayPal ? 'checked' : '' %> >
                        <div class="payment-details">
                            <div class="payment-title">Cash on Delivery (COD)</div>
                            <div class="payment-desc">Pay when you receive your order</div>
                        </div>
                        <i class="fas fa-money-bill-wave" style="font-size: 1.5rem; color: var(--success-color);"></i>
                        </div>
                        <% } %>

                        <!-- Card form stays hidden (you’re not using it yet) -->
                        <div id="card-form" style="display:none; margin-top:2rem; padding-top:2rem; border-top:1px solid var(--border-color);">
                        <!-- ...unchanged... -->
                        </div>

                        <div class="step-buttons">
                        <button class="btn btn-outline" onclick="prevStep()">Back to Shipping</button>
                        <button class="btn btn-primary" onclick="nextStep()">Review Order</button>
                        </div>
                    </div>
                    </div>


                    <!-- Step 3: Order Review -->
                    <div class="step-content" id="step-3">
                        <div class="checkout-card">
                            <h3 class="card-title">ORDER REVIEW</h3>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Shipping Address</h5>
                                    <div id="review-shipping" style="color: var(--accent-color); font-size: 0.9rem;">
                                        <div>John Doe</div>
                                        <div>123 Main Street</div>
                                        <div>Cebu City, Cebu 6000</div>
                                        <div>+63 912 345 6789</div>
                                        <div>john.doe@email.com</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Payment Method</h5>
                                    <div id="review-payment" style="color: var(--accent-color); font-size: 0.9rem;">
                                    <% if (settings && !settings.pay_paypal && settings.pay_cod) { %>
                                        <div>Cash on Delivery (COD)</div>
                                        <div>Pay when you receive your order</div>
                                    <% } else { %>
                                        <div>PayPal</div>
                                        <div>Pay securely with your PayPal account</div>
                                    <% } %>
                                    </div>
                                </div>
                            </div>

                            <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Order Items</h5>
                            <div id="review-items">
                            <% items.forEach(function(it) { %>
                                <div class="order-item">
                                <div class="item-image">
                                    <% if (it.image) { %>
                                    <img src="<%= it.image %>" 
                                        alt="<%= it.product_name %>" 
                                        style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
                                    <% } else { %>
                                    <i class="fas fa-mobile-alt"></i>
                                    <% } %>
                                </div>
                                <div class="item-info">
                                    <div class="item-name"><%= it.product_name %></div>
                                    <div class="item-qty">Qty: <%= it.quantity %></div>
                                    <div class="item-variant">
                                    <%= it.color %> • <%= it.ram %>GB RAM • <%= it.storage %>GB
                                    </div>
                                </div>
                                <div class="item-price">₱<%= (it.price * it.quantity).toLocaleString() %></div>
                                </div>
                            <% }) %>
                            </div>

                            <!-- Step 3: Order Review  -->
                            <div class="step-buttons">
                            <button class="btn btn-outline" onclick="prevStep()">Back to Payment</button>

                            <!-- COD Place Order (hidden by default; JS will show if COD is selected) -->
                            <button id="codPlaceOrderBtn" class="btn btn-primary" onclick="handleCODOrder()" style="display:none;">
                                Place Order (COD)
                            </button>

                            <!-- PayPal Button Container (hidden by default; JS will show if PayPal is selected) -->
                            <div id="paypal-button-container" style="display:none;"></div>
                            </div>

                        </div>
                    </div>

                    <!-- Step 4: Order Confirmation -->
                    <!-- Step 4: Order Confirmation -->
                    <div class="step-content" id="step-4">
                    <div class="checkout-card">
                        <div class="confirmation-icon">
                        <i class="fas fa-check-circle"></i>
                        </div>
                        <h2 class="confirmation-title">Order Confirmed!</h2>
                        <p class="confirmation-desc">Thank you for your purchase. Your order has been successfully placed and is being processed.</p>

                        <div class="order-details">
                        <div class="detail-row">
                            <span style="font-weight: 600;">Order Number:</span>
                            <span id="conf-order-number">#TE—</span>
                        </div>
                        <div class="detail-row">
                            <span style="font-weight: 600;">Estimated Delivery:</span>
                            <span id="conf-estimated-delivery">—</span>
                        </div>
                        <div class="detail-row">
                            <span style="font-weight: 600;">Tracking Email:</span>
                            <span id="conf-email">—</span>
                        </div>
                        </div>

                        <div class="step-buttons">
                        <button class="btn btn-primary" onclick="continueShopping()">Continue Shopping</button>
                        <button class="btn btn-outline" onclick="trackOrder()">Track Order</button>
                        </div>
                    </div>
                    </div>
                </div>
                
                <!-- Order Summary Sidebar -->
                <div class="col-lg-4 col-md-5">
                <div class="order-summary">
                    <h3 class="summary-title">ORDER SUMMARY</h3>

                    <% items.forEach(item => { %>
                    <div class="order-item">
                        <div class="item-image">
                        <% if (item.image) { %>
                            <img src="<%= item.image %>" alt="<%= item.product_name %>" style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
                        <% } else { %>
                            <i class="fas fa-mobile-alt"></i>
                        <% } %>
                        </div>
                        <div class="item-info">
                        <div class="item-name"><%= item.product_name %></div>
                        <div class="item-qty">Qty: <%= item.quantity %></div>
                        <div class="item-variant"><%= item.color %> • <%= item.ram %>GB RAM • <%= item.storage %>GB</div>
                        </div>
                        <div class="item-price">₱<%= (item.price * item.quantity).toLocaleString() %></div>
                    </div>
                    <% }) %>

                    <div class="summary-divider"></div>

                    <div class="summary-row">
                    <span class="summary-label">Subtotal</span>
                    <span class="summary-value" id="sum-subtotal">₱<%= subtotal.toFixed(2) %></span>
                    </div>

                    <!-- Voucher input -->
                    <div class="input-group my-2">
                    <input id="voucher-code" type="text" class="form-control" placeholder="Voucher code">
                    <button id="voucher-apply" class="btn btn-outline-dark" type="button">Apply</button>
                    <button id="voucher-clear" class="btn btn-outline-secondary d-none" type="button">Remove</button>
                    </div>
                    <div id="voucher-msg" class="small text-muted"></div>

                    <div class="summary-row">
                    <span class="summary-label">Discount</span>
                    <span class="summary-value" id="sum-discount">- ₱0.00</span>
                    </div>
                    <div class="summary-row">
                    <span class="summary-label">Shipping</span>
                    <span class="summary-value" id="sum-shipping">
                        <% if (Number(shipping) === 0) { %>
                        FREE
                        <% } else { %>
                        ₱<%= Number(shipping).toFixed(2) %>
                        <% } %>
                    </span>
                    </div>

                    <div class="summary-row">
                    <span class="summary-label">Tax</span>
                    <span class="summary-value" id="sum-tax">₱<%= tax.toFixed(2) %></span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row total-row">
                    <span class="summary-label">Total</span>
                    <span class="summary-value" id="sum-total">₱<%= total.toFixed(2) %></span>
                    </div>
                </div>
                </div>


    
    <footer>
        <%- include("../partials/footer.ejs") %>
    </footer>

</body>


   <% if (settings && settings.pay_paypal) { %>
<script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=PHP"></script>
<% } %>

    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
    <script src="/js/checkout.js"></script>
</html>

  
