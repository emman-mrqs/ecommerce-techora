<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TECHORA ‚Äî Account</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/profile.css">
</head>
<body>

  <nav>
    <%- include("../partials/header.ejs") %>
  </nav>

<div class="wrap" id="app" aria-live="polite">

  <!-- Sidebar -->
  <aside class="sidebar">

    <% const _user = (typeof user !== 'undefined' && user) ? user : {}; %>
    <% const _avatarSeed = (_user.name && _user.name.trim().length) ? _user.name : 'TU'; %>

    <div class="me" id="meBox">
      <div class="avatar" id="meAvatar"><%= _avatarSeed.slice(0,2).toUpperCase() %></div>
      <div class="meta">
        <strong id="meName"><%= _user.name || 'Techora User' %></strong>
        <small id="meEmail"><%= _user.email || 'user@example.com' %></small>
        <!-- <small class="text-muted">Session: <%= typeof sessionID !== 'undefined' ? sessionID : '' %></small> -->
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="Account sections">
      <button class="active" data-view="profile"><span class="icon">üë§</span> Profile</button>
      <button data-view="orders"><span class="icon">üßæ</span> My Orders</button>
      <button data-view="settings"><span class="icon">‚öôÔ∏è</span> Settings</button>
      <button data-action="logout" class="ghost" style="margin-top:8px"><span class="icon">‚Ü™</span> Logout</button>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="content">

    <!-- PROFILE -->
    <section data-route="profile" class="route">
      <div class="page-title"><h2>Profile</h2></div>

      <div class="panel">
        <div class="head"><strong>Personal Info</strong>
          <div class="actions">
            <button class="btn outline" id="btnEditProfile">Edit</button>
            <button class="btn" id="btnSaveProfile" style="display:none">Save</button>
          </div>
        </div>
        <div class="body">
          <div class="grid-3">
            <div class="stack">
              <label for="pfName">Full Name</label>
              <input id="pfName" type="text" placeholder="Your name" disabled>
            </div>
            <div class="stack">
              <label for="pfEmail">Email</label>
              <input id="pfEmail" type="email" placeholder="you@domain.com" disabled>
            </div>
            <div class="stack">
              <label for="pfPhone">Phone</label>
              <input id="pfPhone" type="tel" placeholder="+63 900 000 0000" disabled>
            </div>
          </div>

          <div class="grid-3" style="margin-top:12px">
            <div class="stack">
              <label for="pfUsername">Username</label>
              <input id="pfUsername" type="text" placeholder="username" disabled>
            </div>
            <div class="stack">
              <label for="pfBio">About</label>
              <input id="pfBio" type="text" placeholder="Tell us about you" disabled>
            </div>
            <div class="stack">
              <label for="pfAvatar">Avatar (initials)</label>
              <input id="pfAvatar" maxlength="2" placeholder="e.g. TM" disabled>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="head"><strong>Security</strong></div>
        <div class="body">
          <div class="grid-3">
            <div class="stack">
              <label for="pfPasswordNow">Current Password</label>
              <input id="pfPasswordNow" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="stack">
              <label for="pfPasswordNew">New Password</label>
              <input id="pfPasswordNew" type="password" placeholder="Minimum 6 chars">
            </div>
            <div class="stack">
              <label>&nbsp;</label>
              <button class="btn" id="btnChangePassword">Change Password</button>
            </div>
          </div>
          <small class="muted" style="color:var(--muted)">Passwords are stored locally in your browser for demo purposes only.</small>
        </div>
      </div>
    </section>

    <!-- ORDERS -->
    <section data-route="orders" class="route" <% if ((typeof route !== 'undefined' ? route : 'profile') !== 'orders') { %>hidden<% } %>>
      <div class="page-title"><h2>My Orders</h2></div>

      <div class="tabs" id="orderTabs" role="tablist" aria-label="Order status">
        <% const TABS = ['All','Pending','To Ship','To Receive','Completed','Cancelled','Return/Refund']; %>
        <% TABS.forEach((t, i) => { %>
          <button class="tab <%= i===0 ? 'active' : '' %>" role="tab"
                  data-status="<%= t %>"
                  data-count="<%= (ordersByStatus[t] || []).length %>">
            <%= t %> (<%= (ordersByStatus[t] || []).length %>)
          </button>
        <% }) %>
      </div>

      <div class="order-list" id="orderList" aria-live="polite">
        <% (allOrders || []).forEach(o => { %>
          <div class="order" data-status="<%= o.ui_status %>">
            <div class="row">
              <div>
                <strong>Order</strong> ‚Ä¢ <span class="badge"><%= o.ui_status %></span><br>
                <small style="color:var(--muted)">Order ID: <%= o.id %> ¬∑ <%= new Date(o.created_at).toLocaleString() %></small>
              </div>
              <div class="actions">
                <% if (o.ui_status === 'Pending') { %>
                  <!-- Pay Now intentionally hidden per request -->
                  <button class="btn outline btn-cancel-order" data-order-id="<%= o.id %>">Cancel</button>
                <% } %>
                <% if (o.ui_status === 'To Ship') { %>
                  <a href="/track/<%= o.id %>" class="btn outline">Track</a>
                  <button class="btn outline btn-cancel-order" data-order-id="<%= o.id %>">Cancel</button>
                <% } %>
                <% if (o.ui_status === 'To Receive') { %>
                  <form method="post" action="/api/orders/receive/<%= o.id %>">
                    <button class="btn">Mark Received</button>
                  </form>
                <% } %>
              </div>
            </div>

            <div class="items">
              <% o.items.forEach(it => { %>
                <div class="line">
                  <div style="display:flex;gap:10px;align-items:center">
                    <img src="<%= it.img_url || '/img/placeholder.png' %>" alt=""
                         style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
                    <div>
                      <div><%= it.product_name %></div>
                      <small style="color:var(--muted)">
                        <%= [ it.color ? ('Color: ' + it.color) : null,
                              it.storage ? ('Storage: ' + it.storage) : null,
                              it.ram ? ('RAM: ' + it.ram) : null ].filter(Boolean).join(' ‚Ä¢ ') %>
                      </small>
                    </div>
                  </div>
                  <div>
                    <div>‚Ç±<%= Number(it.unit_price).toFixed(2) %> √ó <%= it.quantity %></div>
                    <div><strong>‚Ç±<%= Number(it.total_price).toFixed(2) %></strong></div>
                  </div>
                </div>
              <% }) %>
            </div>

            <!-- Invoice / Payment summary -->
            <div class="panel" style="margin-top:8px">
              <div class="head"><strong>Invoice</strong></div>
              <div class="body grid-3">
                <div class="stack">
                  <small class="muted">Payment Method</small>
                  <div><%= (o.payment && o.payment.method) ? o.payment.method : (o.payment_method || '‚Äî') %></div>
                </div>
                <div class="stack">
                  <small class="muted">Payment Status</small>
                  <div><%= (o.payment && o.payment.status) ? o.payment.status : (o.payment_status || 'Unpaid') %></div>
                </div>
                <div class="stack">
                  <small class="muted">Transaction ID</small>
                  <div><%= (o.payment && o.payment.transaction_id) ? o.payment.transaction_id : '‚Äî' %></div>
                </div>
                <div class="stack">
                  <small class="muted">Amount Paid</small>
                  <div>‚Ç±<%= Number((o.payment && o.payment.amount_paid) ? o.payment.amount_paid : 0).toFixed(2) %></div>
                </div>
                <div class="stack">
                  <small class="muted">Order Total</small>
                  <div>‚Ç±<%= Number(o.total_amount || (o.payment && o.payment.amount) || 0).toFixed(2) %></div>
                </div>
                <div class="stack">
                  <small class="muted">Payment Date</small>
                  <div>
                    <% if (o.payment && o.payment.payment_date) { %>
                      <%= new Date(o.payment.payment_date).toLocaleString() %>
                    <% } else { %> ‚Äî <% } %>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="badge">Ship to: <%= o.shipping_address || '‚Äî' %></div>
              <div>
                <% const computedTotal = o.total_amount ?? o.items.reduce((s,x)=>s + (x.total_price ?? (x.unit_price * x.quantity)), 0); %>
                <strong>Total: ‚Ç±<%= Number(computedTotal).toFixed(2) %></strong>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="empty" id="ordersEmpty" <% if ((allOrders || []).length) { %>hidden<% } %>>
        <div class="center" style="flex-direction:column;gap:8px">
          <div style="font-size:40px">üìÑ</div>
          <div>No orders yet</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section data-route="settings" class="route" hidden>
      <div class="page-title"><h2>Settings</h2></div>

      <div class="grid-2">
        <!-- Addresses -->
        <div class="panel">
          <div class="head"><strong>Shipping Addresses</strong>
            <div class="actions"><button class="btn" id="btnAddAddress">Add Address</button></div>
          </div>
          <div class="body stack" id="addressList">
            <!-- addresses -->
          </div>
        </div>

        <!-- Account -->
        <div class="panel">
          <div class="head"><strong>Account</strong></div>
          <div class="body stack">
            <div class="stack">
              <label for="chgEmail">Change Account (Email)</label>
              <div class="actions" style="gap:8px">
                <input id="chgEmail" type="email" placeholder="new-email@domain.com" style="max-width:320px">
                <button class="btn outline" id="btnChangeAccount">Update Email</button>
              </div>
            </div>
            <hr style="border:0;border-top:1px solid var(--border)">
            <div class="stack">
              <label>Danger Zone</label>
              <div class="actions">
                <button class="btn danger" id="btnDeleteAccount">Delete Account</button>
                <button class="btn outline" data-action="logout">Logout</button>
              </div>
              <small class="muted" style="color:var(--muted)">Deleting account clears all local data (profile, orders, addresses).</small>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Modal (reused) -->
<div class="modal-bg" id="modalBg" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="modalTitle">
    <div class="head">
      <strong id="modalTitle">Modal</strong>
      <button class="btn ghost" id="modalClose" aria-label="Close">‚úï</button>
    </div>
    <div class="body" id="modalBody"></div>
    <div class="foot" id="modalFoot"></div>
  </div>
</div>

<!-- Logged-out overlay -->
<div class="logout-overlay" id="logoutLayer">
  <div class="logout-card">
    <h3>You are logged out</h3>
    <p class="muted" style="color:var(--muted)">This is a front-end demo. Click below to sign back in (restores your local data).</p>
    <div class="actions">
      <button class="btn" id="btnLoginAgain">Login</button>
      <button class="btn outline" id="btnClearAll">Clear all data</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<footer>
  <%- include("../partials/footer.ejs") %>
</footer>

<!-- IMPORTANT: no inline JS here. Let /js/profile.js attach handlers (incl. Cancel modal). -->
<script src="/js/profile.js"></script>
</body>
</html>
