<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audit Logs - TECHORA</title>
  <link rel="stylesheet" href="/css/adminSideBarNav.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* small tweak to keep details column readable on mobile */
    @media (max-width: 767px) {
      .table-responsive td { word-break: break-word; font-size: 13px; }
      .audit-details { max-width: 180px; }
    }
  </style>
</head>
<body>
  <%- include("../partials/adminSidebarNav", { activePage: "audit", pageTitle: "Audit Logs" }) %>

  <div class="main-content p-4">
    <h5 class="fw-bold mb-3">Audit Logs</h5>

    <form method="get" class="d-flex flex-wrap gap-2 mb-3 align-items-center">
      <div class="input-group" style="max-width: 350px;">
        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
        <input
          name="search"
          value="<%= typeof search !== 'undefined' ? search : '' %>"
          type="text"
          class="form-control"
          placeholder="Search by actor, action, resource..."
        />
      </div>

      <select name="timeframe" class="form-select" style="max-width: 180px;">
        <option value="24h" <%= (typeof timeframe !== 'undefined' && timeframe === '24h') ? 'selected' : '' %>>Last 24 hours</option>
        <option value="7d"  <%= (typeof timeframe !== 'undefined' && timeframe === '7d') ? 'selected' : '' %>>Last 7 days</option>
        <option value="30d" <%= (typeof timeframe !== 'undefined' && timeframe === '30d') ? 'selected' : '' %>>Last 30 days</option>
        <option value="year" <%= (typeof timeframe !== 'undefined' && timeframe === 'year') ? 'selected' : '' %>>This year</option>
        <option value="" <%= (typeof timeframe === 'undefined' || !timeframe) ? 'selected' : '' %>>All time</option>
      </select>

      <select name="action" class="form-select" style="max-width: 180px;">
        <option value="" <%= (typeof action === 'undefined' || !action) ? 'selected' : '' %>>All Actions</option>
        <option value="login"         <%= (typeof action !== 'undefined' && action === 'login') ? 'selected' : '' %>>Login</option>
        <option value="logout"        <%= (typeof action !== 'undefined' && action === 'logout') ? 'selected' : '' %>>Logout</option>
        <option value="order_create"  <%= (typeof action !== 'undefined' && action === 'order_create') ? 'selected' : '' %>>Order</option>
        <option value="payment"       <%= (typeof action !== 'undefined' && action === 'payment') ? 'selected' : '' %>>Payment</option>
        <option value="product_create"<%= (typeof action !== 'undefined' && action === 'product_create') ? 'selected' : '' %>>Product Create</option>
        <option value="product_update"<%= (typeof action !== 'undefined' && action === 'product_update') ? 'selected' : '' %>>Product Update</option>
        <option value="product_delete"<%= (typeof action !== 'undefined' && action === 'product_delete') ? 'selected' : '' %>>Product Delete</option>
        <option value="review_create" <%= (typeof action !== 'undefined' && action === 'review_create') ? 'selected' : '' %>>Review</option>
        <option value="promotion_create" <%= (typeof action !== 'undefined' && action === 'promotion_create') ? 'selected' : '' %>>Promotion Create</option>
        <option value="promotion_update" <%= (typeof action !== 'undefined' && action === 'promotion_update') ? 'selected' : '' %>>Promotion Update</option>
        <option value="promotion_delete" <%= (typeof action !== 'undefined' && action === 'promotion_delete') ? 'selected' : '' %>>Promotion Delete</option>
      </select>

      <!-- perPage selector (default 10) -->
      <select name="perPage" class="form-select" style="max-width:120px;">
        <option value="10" <%= (typeof perPage !== 'undefined' && Number(perPage) === 10) ? 'selected' : '' %>>10</option>
        <option value="25" <%= (typeof perPage !== 'undefined' && Number(perPage) === 25) ? 'selected' : '' %>>25</option>
        <option value="50" <%= (typeof perPage !== 'undefined' && Number(perPage) === 50) ? 'selected' : '' %>>50</option>
      </select>

      <div>
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>

    <div class="card">
      <div class="card-header fw-bold">Activity Log (<%= typeof total !== 'undefined' ? total : 0 %>)</div>
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Actor</th>
              <th>Action</th>
              <th>Resource</th>
              <th>Details</th>
              <th>Timestamp</th>
              <th>IP</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% if (typeof audits === 'undefined' || !audits || audits.length === 0) { %>
              <tr>
                <td colspan="7" class="text-center text-muted p-4">No audit logs found matching your criteria.</td>
              </tr>
            <% } else { %>
              <% audits.forEach(function(a) { %>
                <% 
                  // Safely render details (handles JSON object, JSON string, or plain string)
                  let detailsText = '';
                  try {
                    if (!a.details) {
                      detailsText = '';
                    } else if (typeof a.details === 'object') {
                      detailsText = JSON.stringify(a.details, null, 2);
                    } else {
                      try {
                        detailsText = JSON.stringify(JSON.parse(a.details), null, 2);
                      } catch(e) {
                        detailsText = String(a.details);
                      }
                    }
                  } catch (e) {
                    detailsText = String(a.details || '');
                  }
                %>
                <tr>
                  <td>
                    <small class="text-muted"><%= a.actor_type || '' %></small><br/>
                    <strong><%= a.actor_name || ('#' + (a.actor_id || '—')) %></strong>
                  </td>
                  <td><%= a.action || '' %></td>
                  <td><%= a.resource || '' %></td>
                  <td class="audit-details" style="white-space:pre-wrap;"><%= detailsText %></td>
                  <td><%= a.created_at ? (new Date(a.created_at)).toLocaleString() : '' %></td>
                  <td><%= a.ip || '' %></td>
                  <td>
                    <% if (a.status === 'success') { %>
                      <span class="badge bg-success"><%= a.status %></span>
                    <% } else if (a.status === 'failed') { %>
                      <span class="badge bg-danger"><%= a.status %></span>
                    <% } else { %>
                      <span class="badge bg-secondary"><%= a.status || 'unknown' %></span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
        <div class="small text-muted mb-2 mb-md-0">
          Showing page <strong><%= typeof page !== 'undefined' ? page : 1 %></strong> of <strong><%= typeof lastPage !== 'undefined' ? lastPage : 1 %></strong>
        </div>

        <div class="d-flex align-items-center gap-2">
          <% 
            // helper to build query preserving filters + perPage
            function buildQuery(p) {
              const parts = [];
              if (typeof search !== 'undefined' && search) parts.push('search=' + encodeURIComponent(search));
              if (typeof action !== 'undefined' && action) parts.push('action=' + encodeURIComponent(action));
              if (typeof timeframe !== 'undefined' && timeframe) parts.push('timeframe=' + encodeURIComponent(timeframe));
              parts.push('page=' + p);
              parts.push('perPage=' + (typeof perPage !== 'undefined' ? perPage : 10));
              return '?' + parts.join('&');
            }
          %>

          <nav aria-label="Audit pagination">
            <ul class="pagination mb-0 flex-wrap">
              <!-- First -->
              <li class="page-item <%= (typeof page === 'undefined' || page <= 1) ? 'disabled' : '' %>">
                <a class="page-link" href="<%= buildQuery(1) %>">« First</a>
              </li>

              <!-- Prev -->
              <li class="page-item <%= (typeof page === 'undefined' || page <= 1) ? 'disabled' : '' %>">
                <a class="page-link" href="<%= buildQuery((typeof page !== 'undefined' ? page - 1 : 1)) %>">‹ Prev</a>
              </li>

              <!-- numeric pages (from controller.pages) -->
              <% if (Array.isArray(pages) && pages.length) { %>
                <% pages.forEach(function(p) { %>
                  <li class="page-item <%= (p === page) ? 'active' : '' %>">
                    <a class="page-link" href="<%= buildQuery(p) %>"><%= p %></a>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="page-item disabled"><a class="page-link">1</a></li>
              <% } %>

              <!-- Next -->
              <li class="page-item <%= (typeof page !== 'undefined' && typeof lastPage !== 'undefined' && page >= lastPage) ? 'disabled' : '' %>">
                <a class="page-link" href="<%= buildQuery((typeof page !== 'undefined' ? page + 1 : 2)) %>">Next ›</a>
              </li>

              <!-- Last -->
              <li class="page-item <%= (typeof page !== 'undefined' && typeof lastPage !== 'undefined' && page >= lastPage) ? 'disabled' : '' %>">
                <a class="page-link" href="<%= buildQuery(typeof lastPage !== 'undefined' ? lastPage : 1) %>">Last »</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/adminSideBarNav.js"></script>
</body>
</html>
