<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sellers Management - TECHORA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/adminSellers.css">
</head>
<body>
  <!-- Sidebar + Header -->
  <%- include("../partials/adminSidebarNav", { activePage: "sellers", pageTitle: "Sellers Management" }) %>

  <!-- Main Content -->
<div class="main-content p-4">

  <% 
    const __pending   = pendingSellers.length;
    const __approved  = activeSellers.length;
    const __suspended = suspendedSellers.length;
    const __total     = __approved + __suspended;
  %>

  <!-- Page title + quick stats (consistent with Users page) -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h5 class="fw-bold mb-0">Sellers Management</h5>
    <div class="d-flex gap-2">
      <span class="chip chip-muted"   title="All sellers"><i class="fa-regular fa-user me-1"></i><%= __total %></span>
      <span class="chip chip-success" title="Approved"><i class="fa-solid fa-check me-1"></i><%= __approved %></span>
      <span class="chip chip-danger"  title="Suspended"><i class="fa-solid fa-ban me-1"></i><%= __suspended %></span>
      <span class="chip chip-warn"    title="Pending applications"><i class="fa-solid fa-hourglass-half me-1"></i><%= __pending %></span>
    </div>
  </div>

  <!-- ============ Pending Applications ============ -->
  <div class="sellers-card card border-0 shadow-sm rounded-4 p-3 p-md-4 mb-4">
    <h6 class="fw-bold mb-3">Pending Applications</h6>

    <div class="table-responsive sellers-table-wrap">
      <table class="table align-middle table-hover table-borderless table-striped mb-0">
        <caption class="visually-hidden">Pending seller applications</caption>
        <thead class="table-light sticky-top">
          <tr>
            <th>Store Name</th>
            <th>Owner Email</th>
            <th class="col-address">Business Address</th>
            <th>Date Applied</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (__pending > 0) { %>
            <% pendingSellers.forEach(seller => { %>
              <tr>
                <td><%= seller.store_name %></td>
                <td><%= seller.user_email %></td>
                <td class="col-address"><%= seller.business_address %></td>
                <td><%= new Date(seller.created_at).toDateString() %></td>
                <td class="text-center table-actions">
                  <button class="btn btn-outline-primary btn-sm me-1"
                          title="View details"
                          data-bs-toggle="modal"
                          data-bs-target="#viewSellerModal<%= seller.id %>">
                    <i class="fas fa-eye"></i>
                  </button>

                  <button type="button"
                          class="btn btn-outline-success btn-sm me-1 js-seller-action"
                          title="Approve seller"
                          data-action="approve"
                          data-id="<%= seller.id %>"
                          data-name="<%= seller.store_name %>">
                    <i class="fas fa-check"></i>
                  </button>
                <button type="button"
                        class="btn btn-outline-danger btn-sm js-seller-reject"
                        title="Reject application"
                        data-id="<%= seller.id %>"
                        data-name="<%= seller.store_name %>">
                  <i class="fas fa-times"></i>
                </button>

                </td>
              </tr>

              <!-- View Modal (Pending) — unchanged -->
              <div class="modal fade" id="viewSellerModal<%= seller.id %>" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title"><i class="fa-solid fa-store me-2"></i><%= seller.store_name %> — Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Owner Name:</strong></p>
                          <p class="text-muted"><%= seller.owner_name %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Owner Email:</strong></p>
                          <p class="text-muted"><%= seller.user_email %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Category:</strong></p>
                          <p class="text-muted"><%= seller.category %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Store Email:</strong></p>
                          <p class="text-muted"><%= seller.store_email || '—' %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Contact Number:</strong></p>
                          <p class="text-muted"><%= seller.contact_number || '—' %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Status:</strong></p>
                          <p class="text-muted"><%= seller.status %></p>
                        </div>
                        <div class="col-12">
                          <p class="mb-1"><strong>Business Address:</strong></p>
                          <p class="text-muted"><%= seller.business_address %></p>
                        </div>
                        <div class="col-12">
                          <p class="mb-1"><strong>Description:</strong></p>
                          <p class="text-muted"><%= seller.description || '—' %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Applied At:</strong></p>
                          <p class="text-muted"><%= new Date(seller.created_at).toLocaleString() %></p>
                        </div>
                        <div class="col-md-6">
                          <p class="mb-1"><strong>Last Updated:</strong></p>
                          <p class="text-muted"><%= seller.updated_at ? new Date(seller.updated_at).toLocaleString() : '—' %></p>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <tr><td colspan="5" class="text-center text-muted">No pending applications</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ All Sellers ============ -->
  <div class="sellers-card card border-0 shadow-sm rounded-4 p-3 p-md-4">
    <h6 class="fw-bold">All Sellers</h6>

    <div class="table-responsive sellers-table-wrap">
      <table class="table align-middle table-hover table-borderless table-striped mb-0">
        <caption class="visually-hidden">All sellers</caption>
        <thead class="table-light sticky-top">
          <tr>
            <th>Store Name</th>
            <th class="col-address">Business Address</th>
            <th>Owner Email</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% [...activeSellers, ...suspendedSellers].forEach(seller => { %>
            <tr>
              <td><%= seller.store_name %></td>
              <td class="col-address"><%= seller.business_address %></td>
              <td><%= seller.user_email %></td>
              <td>
                <% if (seller.status === 'approved') { %>
                  <span class="status-pill status-active">Active</span>
                <% } else { %>
                  <span class="status-pill status-suspended">Suspended</span>
                <% } %>
              </td>

             <td class="text-center table-actions">
                <!-- View -->
                <button class="btn btn-outline-primary btn-sm me-1"
                        title="View details"
                        data-bs-toggle="modal"
                        data-bs-target="#viewSellerModalAll<%= seller.id %>">
                  <i class="fas fa-eye"></i>
                </button>

                <!-- Edit basic seller fields -->
                <button class="btn btn-outline-secondary btn-sm me-1"
                        title="Edit seller"
                        data-bs-toggle="collapse"
                        data-bs-target="#editRow<%= seller.id %>"
                        aria-expanded="false"
                        aria-controls="editRow<%= seller.id %>">
                  <i class="fas fa-pen"></i>
                </button>

                <% if (seller.status === 'approved') { %>
                  <!-- SUSPEND (create new) -->
                  <button type="button"
                          class="btn btn-sm btn-outline-warning js-seller-suspend"
                          title="Suspend seller"
                          data-id="<%= seller.id %>"
                          data-name="<%= seller.store_name %>"
                          data-status="<%= seller.status %>"
                          data-title=""
                          data-reason=""
                          data-end="">
                    <i class="fas fa-ban"></i>
                  </button>
                <% } else { %>
                  <!-- EDIT SUSPENSION (prefilled) -->
                  <button type="button"
                          class="btn btn-sm btn-outline-warning me-1 js-seller-suspend"
                          title="Edit suspension"
                          data-id="<%= seller.id %>"
                          data-name="<%= seller.store_name %>"
                          data-status="<%= seller.status %>"
                          data-title="<%= seller.suspension_title || '' %>"
                          data-reason="<%= seller.suspension_reason || '' %>"
                          data-end="<%= seller.suspension_lifted_at ? new Date(seller.suspension_lifted_at).toISOString() : '' %>">
                    <i class="fas fa-pen"></i>
                  </button>

                  <!-- LIFT SUSPENSION (manual unsuspend) -->
                  <form method="post"
                        action="/admin/sellers/<%= seller.id %>/unsuspend"
                        class="d-inline">
                    <button type="submit"
                            class="btn btn-sm btn-outline-success"
                            title="Lift suspension">
                      <i class="fas fa-check"></i>
                    </button>
                  </form>
                <% } %>
              </td>
            </tr>

            <!-- Collapsible editor row (unchanged) -->
            <tr class="collapse" id="editRow<%= seller.id %>">
              <td colspan="5" class="bg-light">
                <form method="post" action="/admin/sellers/<%= seller.id %>/update" class="p-3">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Store Name</label>
                      <input type="text" name="store_name" class="form-control" value="<%= seller.store_name || '' %>" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Category</label>
                      <input type="text" name="category" class="form-control" value="<%= seller.category || '' %>">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Store Email</label>
                      <input type="email" name="store_email" class="form-control" value="<%= seller.store_email || '' %>">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Contact Number</label>
                      <input type="text" name="contact_number" class="form-control" value="<%= seller.contact_number || '' %>">
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">Business Address</label>
                      <input type="text" name="business_address" class="form-control" value="<%= seller.business_address || '' %>">
                    </div>
                    <div class="col-12">
                      <label class="form-label">Description</label>
                      <textarea name="description" rows="3" class="form-control"><%= seller.description || '' %></textarea>
                    </div>
                    <div class="col-12 d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-floppy-disk me-1"></i> Save Changes
                      </button>
                      <button type="button" class="btn btn-outline-secondary"
                              data-bs-toggle="collapse"
                              data-bs-target="#editRow<%= seller.id %>">
                        Cancel
                      </button>
                    </div>
                  </div>
                </form>
              </td>
            </tr>

            <!-- View Modal (All Sellers) — unchanged -->
            <div class="modal fade" id="viewSellerModalAll<%= seller.id %>" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title"><i class="fa-solid fa-store me-2"></i><%= seller.store_name %> — Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row g-3">
                      <!-- details unchanged -->
                      <div class="col-md-6"><p class="mb-1"><strong>Owner Name:</strong></p><p class="text-muted"><%= seller.owner_name %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Owner Email:</strong></p><p class="text-muted"><%= seller.user_email %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Category:</strong></p><p class="text-muted"><%= seller.category %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Store Email:</strong></p><p class="text-muted"><%= seller.store_email || '—' %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Contact Number:</strong></p><p class="text-muted"><%= seller.contact_number || '—' %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Status:</strong></p><p class="text-muted"><%= seller.status %></p></div>
                      <div class="col-12"><p class="mb-1"><strong>Business Address:</strong></p><p class="text-muted"><%= seller.business_address %></p></div>
                      <div class="col-12"><p class="mb-1"><strong>Description:</strong></p><p class="text-muted"><%= seller.description || '—' %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Created At:</strong></p><p class="text-muted"><%= new Date(seller.created_at).toLocaleString() %></p></div>
                      <div class="col-md-6"><p class="mb-1"><strong>Last Updated:</strong></p><p class="text-muted"><%= seller.updated_at ? new Date(seller.updated_at).toLocaleString() : '—' %></p></div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>


  <!-- Confirm Seller Action Modal -->
<div class="modal fade" id="confirmSellerActionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><!-- centered -->
    <div class="modal-content">
      <form method="post" id="sellerActionForm">
        <div class="modal-header">
          <h5 class="modal-title" id="sellerModalTitle">Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- text-left -->
        <div class="modal-body text-start">
          <p class="mb-0">
            <span id="sellerModalMsg">Are you sure?</span>
            <strong id="sellerName" class="ms-1"></strong>
          </p>
        </div>

        <!-- buttons-right -->
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="sellerModalSubmit" class="btn">Confirm</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Suspend/Edit Seller Modal -->
<div class="modal fade" id="sellerSuspendModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="sellerSuspendForm">
        <div class="modal-header">
          <h5 class="modal-title" id="sellerSuspendTitle">Suspend Seller</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Suspension Title</label>
            <input type="text" class="form-control" name="suspension_title" id="suspension_title" required placeholder="e.g. Policy Violation">
          </div>

          <div class="mb-3">
            <label class="form-label">Reason</label>
            <textarea class="form-control" name="suspension_reason" id="suspension_reason" rows="4" placeholder="Describe the issue..."></textarea>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="susp_perm" name="permanent">
            <label class="form-check-label" for="susp_perm">Permanent (no end date)</label>
          </div>

          <div class="mb-2">
            <label class="form-label">Suspension Ends (optional)</label>
            <input type="datetime-local" class="form-control" name="end_date" id="susp_end">
            <small class="text-muted d-block">Leave blank for manual lift. Disabled if permanent.</small>
          </div>
        </div>

        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Save Suspension</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Reject Seller Modal -->
<div class="modal fade" id="rejectSellerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="rejectSellerForm">
        <div class="modal-header">
          <h5 class="modal-title">Reject Application</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="text-muted mb-3">
            You can optionally notify the owner by email.
          </p>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="reject_send_email" name="send_email" />
            <label class="form-check-label" for="reject_send_email">
              Send email to owner
            </label>
          </div>

          <div class="mb-3">
            <label class="form-label">Email Subject</label>
            <input type="text" class="form-control" id="reject_email_subject" name="email_subject" placeholder="Subject">
          </div>

          <div class="mb-2">
            <label class="form-label">Email Message</label>
            <textarea class="form-control" id="reject_email_body" name="email_body" rows="5"
              placeholder="Explain why the application is rejected and how to re-apply."></textarea>
            <small class="text-muted">Leave unchecked to skip sending an email.</small>
          </div>
        </div>

        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Reject</button>
        </div>
      </form>
    </div>
  </div>
</div>


             

  <%- include("../partials/toast", { toast }) %>

  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> -->
  <script src="/js/adminSellers.js"></script>
</body>
</html>
