<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Users Management - TECHORA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/adminUsers.css">
</head>
<body>
  <!-- Sidebar + Header -->
  <%- include("../partials/adminSidebarNav", { activePage: "users", pageTitle: "Users Management" }) %>

<!-- Main Content -->
<div class="main-content p-4">
  <!-- ADD the extra utility classes for a subtle card look -->
  <div class="users-card card border-0 shadow-sm rounded-4 p-3 p-md-4">

    <!-- Title + quick stats -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <h5 class="fw-bold mb-0">Users Management</h5>
      <% const __total = users.length; const __active = users.filter(u => u.status === 'Active').length; const __suspended = __total - __active; %>
      <div class="d-flex gap-2">
        <span class="chip chip-muted" title="Total users"><i class="fa-regular fa-user me-1"></i><%= __total %></span>
        <span class="chip chip-success" title="Active"><i class="fa-solid fa-check me-1"></i><%= __active %></span>
        <span class="chip chip-danger" title="Suspended"><i class="fa-solid fa-ban me-1"></i><%= __suspended %></span>
      </div>
    </div>

    <!-- Thin divider for hierarchy -->
    <hr class="card-sep my-2">

    <!-- Search + Filter -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <div class="input-group soft-input" style="max-width: 520px;">
        <span class="input-group-text bg-transparent border-end-0"><i class="fa-solid fa-magnifying-glass"></i></span>
        <input type="text" id="userSearch" class="form-control border-start-0" placeholder="Search by name or email...">
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label for="statusFilter" class="text-muted small mb-0">Status</label>
        <select id="statusFilter" class="form-select soft-input" style="max-width: 180px;">
          <option value="all">All Status</option>
          <option value="Active">Active</option>
          <option value="Suspended">Suspended</option>
        </select>
      </div>
    </div>

    <!-- Users Table -->
    <div class="table-responsive users-table-wrap">
      <table class="table align-middle table-hover table-borderless table-striped mb-0">
        <caption class="visually-hidden">List of users with name, email, role, status, and actions</caption>
        <thead class="table-light sticky-top">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% if (users.length > 0) { %>
            <% users.forEach(user => { %>
              <tr id="user-row-<%= user.id %>" data-status="<%= user.status %>">
                <td class="user-name">
                  <span class="view-mode d-inline-flex align-items-center gap-2">
                    <span class="avatar circle-24"><%= (user.name || '?').trim().charAt(0).toUpperCase() %></span>
                    <span class="fw-medium"><%= user.name %></span>
                  </span>

                  <form method="post" action="/admin/users/<%= user.id %>/edit" class="edit-mode d-none d-flex align-items-center mt-1">
                    <input type="text" name="name" value="<%= user.name %>" class="form-control form-control-sm me-2 soft-input" style="max-width:200px;" required>
                    <button type="submit" class="btn btn-sm btn-success me-1" aria-label="Save" data-bs-toggle="tooltip" title="Save">
                      <i class="fas fa-check"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-edit" aria-label="Cancel" data-bs-toggle="tooltip" title="Cancel">
                      <i class="fas fa-times"></i>
                    </button>
                  </form>
                </td>

                <td class="text-muted"><%= user.email %></td>

                <td>
                  <% if (user.role === 'admin' || user.is_admin) { %>
                    <span class="role-badge role-admin">Admin</span>
                  <% } else { %>
                    <span class="role-badge role-customer">Customer</span>
                  <% } %>
                </td>

                <td>
                  <% if (user.status === "Active") { %>
                    <span class="status-pill status-active">Active</span>
                  <% } else { %>
                    <span class="status-pill status-suspended">Suspended</span>
                  <% } %>
                </td>

                <td class="text-center table-actions">
                  <button type="button" class="btn btn-sm btn-outline-primary edit-btn" data-user-id="<%= user.id %>" data-bs-toggle="tooltip" title="Edit name">
                    <i class="fas fa-pen"></i>
                  </button>

                  <% if (user.status === "Active") { %>
                    <button type="button" class="btn btn-sm btn-outline-warning open-suspend"
                      data-bs-toggle="modal"
                      data-bs-target="#suspendModal"
                      data-user-id="<%= user.id %>"
                      data-user-name="<%= user.name %>"
                      data-bs-toggle="tooltip" title="Suspend user">
                      <i class="fas fa-ban"></i>
                    </button>
                  <% } else { %>
                    <button type="button" class="btn btn-sm btn-outline-warning open-suspend"
                      data-bs-toggle="modal"
                      data-bs-target="#suspendModal"
                      data-user-id="<%= user.id %>"
                      data-user-name="<%= user.name %>"
                      data-title="<%= user.suspension_title || '' %>"
                      data-reason="<%= user.suspension_reason || '' %>"
                      data-until="<%= user.suspended_until ? user.suspended_until.toISOString().slice(0,10) : '' %>"
                      data-bs-toggle="tooltip" title="Edit suspension">
                      <i class="fas fa-pen"></i>
                    </button>

                    <button type="button" class="btn btn-sm btn-outline-success open-lift"
                      data-bs-toggle="modal"
                      data-bs-target="#liftModal"
                      data-user-id="<%= user.id %>"
                      data-user-name="<%= user.name %>"
                      data-bs-toggle="tooltip" title="Lift suspension">
                      <i class="fas fa-check"></i>
                    </button>
                  <% } %>

                  <button type="button" class="btn btn-sm btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal"
                    data-user-id="<%= user.id %>"
                    data-user-name="<%= user.name %>"
                    data-bs-toggle="tooltip" title="Delete user">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } %>

          <tr id="noUsersRow" class="<%= users.length > 0 ? 'd-none' : '' %>">
            <td colspan="5" class="text-center text-muted">No users found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div> <!-- /.users-card -->
</div> <!-- /.main-content -->

  <!--=================
  MODALS
  ===================-->

  <!-- Suspend / Edit Suspension Modal -->
  <div class="modal fade" id="suspendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="post" id="suspendForm">
          <div class="modal-header">
            <h5 class="modal-title" id="suspendModalTitle">Suspend User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input name="title" id="suspendTitle" type="text" class="form-control" required maxlength="120">
            </div>

            <div class="mb-3">
              <label class="form-label">Reason</label>
              <textarea name="reason" id="suspendReason" rows="4" class="form-control" required></textarea>
            </div>

            <div class="mb-2">
              <label class="form-label d-block">Duration</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="mode" id="modePermanent" value="permanent" checked>
                <label class="form-check-label" for="modePermanent">Permanent</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="mode" id="modeUntil" value="until">
                <label class="form-check-label" for="modeUntil">Until</label>
              </div>
            </div>

            <div class="mb-1">
              <input type="date" name="endDate" id="suspendEndDate" class="form-control" disabled>
              <div class="form-text">Leave blank for permanent suspension.</div>
            </div>
          </div>

          <div class="modal-footer justify-content-end">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lift Suspension Modal -->
  <div class="modal fade" id="liftModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="post" id="liftForm">
          <div class="modal-header">
            <h5 class="modal-title">Lift Suspension</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Lift suspension for <strong id="liftUserName"></strong> now?
          </div>
          <div class="modal-footer justify-content-end">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Lift</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal (inline to avoid missing-partial errors) -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content modal-neutral">
        <form method="post" id="confirmDeleteForm">
          <div class="modal-header">
            <h5 class="modal-title">Delete User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <p class="mb-0">
              Are you sure you want to delete
              <strong id="confirmDeleteUserName">this user</strong>?
              This action cannot be undone.
            </p>
            <input type="hidden" name="userId" id="confirmDeleteUserId"/>
          </div>

          <div class="modal-footer justify-content-end">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Toast Notification -->
  <%- include("../partials/toast", { toast }) %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="/js/adminUsers.js"></script>
</body>
</html>
