<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECHORA - Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/sellerOrders.css">
</head>
<body>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header and Sidebar-->
         <%- include("../partials/sellerSideBarNav.ejs") %>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Orders</h1>
            </div>
            
            <!-- Filters Section -->
            <div class="filters-section">
            <div class="filters-row">
                <!-- Order Status -->
                <div class="filter-group">
                <label class="filter-label">Order Status</label>
                <select class="filter-select" id="filterStatus">
                    <option value="">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">To Ship</option>
                    <option value="shipped">To Receive</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="return">Return/Refund</option>
                </select>
                </div>

                <!-- Date Range -->
                <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select class="filter-select" id="filterDate">
                    <option value="">All Dates</option>
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                </div>

                <!-- Search -->
                <div class="filter-group">
                <label class="filter-label">Search Orders</label>
                <input type="text" id="filterSearch" class="search-input" placeholder="Search by Order ID or Customer Name">
                </div>
            </div>
            </div>
            
            <!-- Orders Table -->
            <div class="orders-table">
            <div class="table-header">
                <div>Product</div>
                <div>Order ID</div>
                <div>Customer Name</div>
                <div>Product Name</div>
                <div>Quantity</div>
                <div>Total Price</div>
                <div>Status</div>
                <div>Date</div>
                <div>Action</div>
            </div>

            <% if (orders.length === 0) { %>
                <div class="text-center p-4">
                <p>No orders found for your products.</p>
                </div>
            <% } else { %>
                <% orders.forEach(order => { %>
                <div class="order-row">
                    <!-- Product Image -->
                    <div class="product-img">
                    <% if (order.product_image) { %>
                        <img src="<%= order.product_image %>" alt="<%= order.product_name %>" style="width:50px; height:50px; object-fit:cover; border-radius:6px;">
                    <% } else { %>
                        <div style="width:50px; height:50px; background:#E0E0E0; display:flex; align-items:center; justify-content:center; border-radius:6px;">
                        <i class="fas fa-box text-muted"></i>
                        </div>
                    <% } %>
                    </div>

                    <div class="order-id"><%= order.order_id %></div>
                    <div class="customer-name"><%= order.customer_name %></div>
                    <div class="product-name"><%= order.product_name %></div>
                    <div class="quantity"><%= order.quantity %></div>
                    <div class="total-price">â‚±<%= order.total_price %></div>
                    <div>
                    <span class="status-badge status-<%= order.order_status.toLowerCase() %>">
                        <%= order.order_status %>
                    </span>
                    </div>
                    <div class="order-date">
                    <%= new Date(order.order_date).toLocaleDateString() %>
                    </div>
                    <div>
                    <button class="action-btn edit"><i class="fas fa-edit"></i></button>
                    <button 
                    class="action-btn view-invoice-btn"
                    data-order='<%- JSON.stringify(order) %>'>
                    <i class="fas fa-eye me-1"></i>
                    </button>
                    <button 
                    class="action-btn delete-order-btn" 
                    title="Delete"
                    data-order-id="<%= order.order_id %>">
                    <i class="fas fa-trash"></i>
                    </button>
                    </div>
                </div>
                <% }) %>
            <% } %>
            </div>
    
            <!-- ðŸ§¾ Invoice Modal -->
            <!-- Empty modal -->
            <div class="modal fade" id="invoiceModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content invoice-card">
                <div class="modal-header" style="background:#000; color:#fff;">
                    <h5 class="modal-title">Invoice</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceContent">
                    <!-- Injected by JS -->
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <!-- Left side -->
                    <small class="text-muted" id="soldBy"></small>

                    <!-- Right side -->
                    <div class="d-flex gap-2">
                        <button id="downloadLabel" class="btn btn-dark">
                            <i class="fas fa-file-download me-1"></i> Download PDF
                        </button>
                        <button id="printInvoice" class="btn btn-outline-dark">
                            <i class="fas fa-print me-1"></i> Print
                        </button>
                    </div>
                </div>
                </div>
            </div>
            </div>

            <!--  Edit Status Modal -->
            <div class="modal fade" id="statusModal" tabindex="-1">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                <div class="modal-header" style="background:#000; color:#fff;">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="statusForm">
                    <div class="modal-body">
                    <input type="hidden" name="order_id" id="statusOrderId">
                    <div class="mb-3">
                        <label for="orderStatus" class="form-label">Select Status</label>
                        <select class="form-select" id="orderStatus" name="order_status">
                        <option value="pending">Pending</option>
                        <option value="confirmed">To Ship</option>
                        <option value="shipped">To Receive</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="return">Return/Refund</option>
                        </select>
                    </div>
                    </div>
                    <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-dark">Update</button>
                    </div>
                </form>
                </div>
            </div>
            </div>

            <!-- Delete Confirm Modal -->
            <div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered delete-modal-md"><!-- custom width -->
                <div class="modal-content border-0 shadow-sm rounded-3">
                <div class="modal-header bg-white border-bottom">
                    <h5 class="modal-title fw-semibold">Delete Order Items</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body text-start">
                    <p class="mb-0">Are you sure you want to delete your products from this order?</p>
                    <input type="hidden" id="deleteOrderId">
                </div>

                <div class="modal-footer bg-white border-top justify-content-end">
                    <button type="button" class="btn btn-outline-secondary rounded-2" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="confirmDeleteOrder" class="btn btn-danger rounded-2">Delete</button>
                </div>
                </div>
            </div>
            </div>

            <!-- Toast (reuse your existing container if you have one) -->
            <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
            <div id="deleteToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                <div class="toast-body">Deleted successfully.</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
            </div>


            <!-- Toast Notification -->
            <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div id="statusToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                <div class="toast-body">
                    Order status updated!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            </div>

            <!-- Pagination -->
            <!-- Pagination -->
            <div class="pagination-container">
            <div class="pagination-info">
                <% 
                const startIdx = totalOrders === 0 ? 0 : ( (page - 1) * perPage + 1 );
                const endIdx = Math.min(page * perPage, totalOrders);
                %>
                Showing <%= startIdx %>-<%= endIdx %> of <%= totalOrders %> orders
            </div>

            <div class="pagination">
                <!-- Prev -->
                <a 
                class="pagination-btn <%= page <= 1 ? 'disabled' : '' %>" 
                href="<%= page <= 1 ? '#' : ('?page=' + (page - 1)) %>"
                aria-disabled="<%= page <= 1 %>"
                >
                <i class="fas fa-chevron-left"></i>
                </a>

                <!-- Page numbers (simple window) -->
                <% 
                const windowSize = 5;
                let startPage = Math.max(1, page - Math.floor(windowSize/2));
                let endPage = Math.min(totalPages, startPage + windowSize - 1);
                if (endPage - startPage + 1 < windowSize) {
                    startPage = Math.max(1, endPage - windowSize + 1);
                }
                for (let p = startPage; p <= endPage; p++) { 
                %>
                <a 
                    class="pagination-btn <%= p === page ? 'active' : '' %>" 
                    href="?page=<%= p %>"
                ><%= p %></a>
                <% } %>

                <!-- Next -->
                <a 
                class="pagination-btn <%= page >= totalPages ? 'disabled' : '' %>" 
                href="<%= page >= totalPages ? '#' : ('?page=' + (page + 1)) %>"
                aria-disabled="<%= page >= totalPages %>"
                >
                <i class="fas fa-chevron-right"></i>
                </a>
            </div>
            </div>

        </div>
    </div>





    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Print Pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/sellerOrders.js"></script>
</body>
</html>
